var K=Object.defineProperty;var Y=(z,e,r)=>e in z?K(z,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):z[e]=r;var A=(z,e,r)=>(Y(z,typeof e!="symbol"?e+"":e,r),r);import{C as I,a as _,v as T,b as F,e as $,c as X}from"./creature-BHTxridD.js";let j=null;class W{}W.render=function(z,e){j(z,e)};self.QrCreator=W;(function(z){function e(g,n,s,l){var t={},i=z(s,n);i.u(g),i.J(),l=l||0;var u=i.h(),h=i.h()+2*l;return t.text=g,t.level=n,t.version=s,t.O=h,t.a=function(w,m){return w-=l,m-=l,0>w||w>=u||0>m||m>=u?!1:i.a(w,m)},t}function r(g,n,s,l,t,i,u,h,w,m){function C(p,y,c,v,M,E,x){p?(g.lineTo(y+E,c+x),g.arcTo(y,c,v,M,i)):g.lineTo(y,c)}u?g.moveTo(n+i,s):g.moveTo(n,s),C(h,l,s,l,t,-i,0),C(w,l,t,n,t,0,-i),C(m,n,t,n,s,i,0),C(u,n,s,l,s,0,i)}function a(g,n,s,l,t,i,u,h,w,m){function C(p,y,c,v){g.moveTo(p+c,y),g.lineTo(p,y),g.lineTo(p,y+v),g.arcTo(p,y,p+c,y,i)}u&&C(n,s,i,i),h&&C(l,s,-i,i),w&&C(l,t,-i,-i),m&&C(n,t,i,-i)}function f(g,n){var s=n.fill;if(typeof s=="string")g.fillStyle=s;else{var l=s.type,t=s.colorStops;if(s=s.position.map(u=>Math.round(u*n.size)),l==="linear-gradient")var i=g.createLinearGradient.apply(g,s);else if(l==="radial-gradient")i=g.createRadialGradient.apply(g,s);else throw Error("Unsupported fill");t.forEach(([u,h])=>{i.addColorStop(u,h)}),g.fillStyle=i}}function o(g,n){t:{var s=n.text,l=n.v,t=n.N,i=n.K,u=n.P;for(t=Math.max(1,t||1),i=Math.min(40,i||40);t<=i;t+=1)try{var h=e(s,l,t,u);break t}catch{}h=void 0}if(!h)return null;for(s=g.getContext("2d"),n.background&&(s.fillStyle=n.background,s.fillRect(n.left,n.top,n.size,n.size)),l=h.O,i=n.size/l,s.beginPath(),u=0;u<l;u+=1)for(t=0;t<l;t+=1){var w=s,m=n.left+t*i,C=n.top+u*i,p=u,y=t,c=h.a,v=m+i,M=C+i,E=p-1,x=p+1,S=y-1,L=y+1,N=Math.floor(Math.min(.5,Math.max(0,n.R))*i),G=c(p,y),U=c(E,S),O=c(E,y);E=c(E,L);var R=c(p,L);L=c(x,L),y=c(x,y),x=c(x,S),p=c(p,S),m=Math.round(m),C=Math.round(C),v=Math.round(v),M=Math.round(M),G?r(w,m,C,v,M,N,!O&&!p,!O&&!R,!y&&!R,!y&&!p):a(w,m,C,v,M,N,O&&p&&U,O&&R&&E,y&&R&&L,y&&p&&x)}return f(s,n),s.fill(),g}var d={minVersion:1,maxVersion:40,ecLevel:"L",left:0,top:0,size:200,fill:"#000",background:null,text:"no text",radius:.5,quiet:0};j=function(g,n){var s={};Object.assign(s,d,g),s.N=s.minVersion,s.K=s.maxVersion,s.v=s.ecLevel,s.left=s.left,s.top=s.top,s.size=s.size,s.fill=s.fill,s.background=s.background,s.text=s.text,s.R=s.radius,s.P=s.quiet,n instanceof HTMLCanvasElement?((n.width!==s.size||n.height!==s.size)&&(n.width=s.size,n.height=s.size),n.getContext("2d").clearRect(0,0,n.width,n.height),o(n,s)):(g=document.createElement("canvas"),g.width=s.size,g.height=s.size,s=o(g,s),n.appendChild(s))}})(function(){function z(n){var s=r.s(n);return{S:function(){return 4},b:function(){return s.length},write:function(l){for(var t=0;t<s.length;t+=1)l.put(s[t],8)}}}function e(){var n=[],s=0,l={B:function(){return n},c:function(t){return(n[Math.floor(t/8)]>>>7-t%8&1)==1},put:function(t,i){for(var u=0;u<i;u+=1)l.m((t>>>i-u-1&1)==1)},f:function(){return s},m:function(t){var i=Math.floor(s/8);n.length<=i&&n.push(0),t&&(n[i]|=128>>>s%8),s+=1}};return l}function r(n,s){function l(p,y){for(var c=-1;7>=c;c+=1)if(!(-1>=p+c||h<=p+c))for(var v=-1;7>=v;v+=1)-1>=y+v||h<=y+v||(u[p+c][y+v]=0<=c&&6>=c&&(v==0||v==6)||0<=v&&6>=v&&(c==0||c==6)||2<=c&&4>=c&&2<=v&&4>=v)}function t(p,y){for(var c=h=4*n+17,v=Array(c),M=0;M<c;M+=1){v[M]=Array(c);for(var E=0;E<c;E+=1)v[M][E]=null}for(u=v,l(0,0),l(h-7,0),l(0,h-7),c=o.G(n),v=0;v<c.length;v+=1)for(M=0;M<c.length;M+=1){E=c[v];var x=c[M];if(u[E][x]==null)for(var S=-2;2>=S;S+=1)for(var L=-2;2>=L;L+=1)u[E+S][x+L]=S==-2||S==2||L==-2||L==2||S==0&&L==0}for(c=8;c<h-8;c+=1)u[c][6]==null&&(u[c][6]=c%2==0);for(c=8;c<h-8;c+=1)u[6][c]==null&&(u[6][c]=c%2==0);for(c=o.w(i<<3|y),v=0;15>v;v+=1)M=!p&&(c>>v&1)==1,u[6>v?v:8>v?v+1:h-15+v][8]=M,u[8][8>v?h-v-1:9>v?15-v:14-v]=M;if(u[h-8][8]=!p,7<=n){for(c=o.A(n),v=0;18>v;v+=1)M=!p&&(c>>v&1)==1,u[Math.floor(v/3)][v%3+h-8-3]=M;for(v=0;18>v;v+=1)M=!p&&(c>>v&1)==1,u[v%3+h-8-3][Math.floor(v/3)]=M}if(w==null){for(p=g.I(n,i),c=e(),v=0;v<m.length;v+=1)M=m[v],c.put(4,4),c.put(M.b(),o.f(4,n)),M.write(c);for(v=M=0;v<p.length;v+=1)M+=p[v].j;if(c.f()>8*M)throw Error("code length overflow. ("+c.f()+">"+8*M+")");for(c.f()+4<=8*M&&c.put(0,4);c.f()%8!=0;)c.m(!1);for(;!(c.f()>=8*M)&&(c.put(236,8),!(c.f()>=8*M));)c.put(17,8);var N=0;for(M=v=0,E=Array(p.length),x=Array(p.length),S=0;S<p.length;S+=1){var G=p[S].j,U=p[S].o-G;for(v=Math.max(v,G),M=Math.max(M,U),E[S]=Array(G),L=0;L<E[S].length;L+=1)E[S][L]=255&c.B()[L+N];for(N+=G,L=o.C(U),G=a(E[S],L.b()-1).l(L),x[S]=Array(L.b()-1),L=0;L<x[S].length;L+=1)U=L+G.b()-x[S].length,x[S][L]=0<=U?G.c(U):0}for(L=c=0;L<p.length;L+=1)c+=p[L].o;for(c=Array(c),L=N=0;L<v;L+=1)for(S=0;S<p.length;S+=1)L<E[S].length&&(c[N]=E[S][L],N+=1);for(L=0;L<M;L+=1)for(S=0;S<p.length;S+=1)L<x[S].length&&(c[N]=x[S][L],N+=1);w=c}for(p=w,c=-1,v=h-1,M=7,E=0,y=o.F(y),x=h-1;0<x;x-=2)for(x==6&&--x;;){for(S=0;2>S;S+=1)u[v][x-S]==null&&(L=!1,E<p.length&&(L=(p[E]>>>M&1)==1),y(v,x-S)&&(L=!L),u[v][x-S]=L,--M,M==-1&&(E+=1,M=7));if(v+=c,0>v||h<=v){v-=c,c=-c;break}}}var i=f[s],u=null,h=0,w=null,m=[],C={u:function(p){p=z(p),m.push(p),w=null},a:function(p,y){if(0>p||h<=p||0>y||h<=y)throw Error(p+","+y);return u[p][y]},h:function(){return h},J:function(){for(var p=0,y=0,c=0;8>c;c+=1){t(!0,c);var v=o.D(C);(c==0||p>v)&&(p=v,y=c)}t(!1,y)}};return C}function a(n,s){if(typeof n.length>"u")throw Error(n.length+"/"+s);var l=function(){for(var i=0;i<n.length&&n[i]==0;)i+=1;for(var u=Array(n.length-i+s),h=0;h<n.length-i;h+=1)u[h]=n[h+i];return u}(),t={c:function(i){return l[i]},b:function(){return l.length},multiply:function(i){for(var u=Array(t.b()+i.b()-1),h=0;h<t.b();h+=1)for(var w=0;w<i.b();w+=1)u[h+w]^=d.i(d.g(t.c(h))+d.g(i.c(w)));return a(u,0)},l:function(i){if(0>t.b()-i.b())return t;for(var u=d.g(t.c(0))-d.g(i.c(0)),h=Array(t.b()),w=0;w<t.b();w+=1)h[w]=t.c(w);for(w=0;w<i.b();w+=1)h[w]^=d.i(d.g(i.c(w))+u);return a(h,0).l(i)}};return t}r.s=function(n){for(var s=[],l=0;l<n.length;l++){var t=n.charCodeAt(l);128>t?s.push(t):2048>t?s.push(192|t>>6,128|t&63):55296>t||57344<=t?s.push(224|t>>12,128|t>>6&63,128|t&63):(l++,t=65536+((t&1023)<<10|n.charCodeAt(l)&1023),s.push(240|t>>18,128|t>>12&63,128|t>>6&63,128|t&63))}return s};var f={L:1,M:0,Q:3,H:2},o=function(){function n(t){for(var i=0;t!=0;)i+=1,t>>>=1;return i}var s=[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],l={w:function(t){for(var i=t<<10;0<=n(i)-n(1335);)i^=1335<<n(i)-n(1335);return(t<<10|i)^21522},A:function(t){for(var i=t<<12;0<=n(i)-n(7973);)i^=7973<<n(i)-n(7973);return t<<12|i},G:function(t){return s[t-1]},F:function(t){switch(t){case 0:return function(i,u){return(i+u)%2==0};case 1:return function(i){return i%2==0};case 2:return function(i,u){return u%3==0};case 3:return function(i,u){return(i+u)%3==0};case 4:return function(i,u){return(Math.floor(i/2)+Math.floor(u/3))%2==0};case 5:return function(i,u){return i*u%2+i*u%3==0};case 6:return function(i,u){return(i*u%2+i*u%3)%2==0};case 7:return function(i,u){return(i*u%3+(i+u)%2)%2==0};default:throw Error("bad maskPattern:"+t)}},C:function(t){for(var i=a([1],0),u=0;u<t;u+=1)i=i.multiply(a([1,d.i(u)],0));return i},f:function(t,i){if(t!=4||1>i||40<i)throw Error("mode: "+t+"; type: "+i);return 10>i?8:16},D:function(t){for(var i=t.h(),u=0,h=0;h<i;h+=1)for(var w=0;w<i;w+=1){for(var m=0,C=t.a(h,w),p=-1;1>=p;p+=1)if(!(0>h+p||i<=h+p))for(var y=-1;1>=y;y+=1)0>w+y||i<=w+y||(p!=0||y!=0)&&C==t.a(h+p,w+y)&&(m+=1);5<m&&(u+=3+m-5)}for(h=0;h<i-1;h+=1)for(w=0;w<i-1;w+=1)m=0,t.a(h,w)&&(m+=1),t.a(h+1,w)&&(m+=1),t.a(h,w+1)&&(m+=1),t.a(h+1,w+1)&&(m+=1),(m==0||m==4)&&(u+=3);for(h=0;h<i;h+=1)for(w=0;w<i-6;w+=1)t.a(h,w)&&!t.a(h,w+1)&&t.a(h,w+2)&&t.a(h,w+3)&&t.a(h,w+4)&&!t.a(h,w+5)&&t.a(h,w+6)&&(u+=40);for(w=0;w<i;w+=1)for(h=0;h<i-6;h+=1)t.a(h,w)&&!t.a(h+1,w)&&t.a(h+2,w)&&t.a(h+3,w)&&t.a(h+4,w)&&!t.a(h+5,w)&&t.a(h+6,w)&&(u+=40);for(w=m=0;w<i;w+=1)for(h=0;h<i;h+=1)t.a(h,w)&&(m+=1);return u+=Math.abs(100*m/i/i-50)/5*10}};return l}(),d=function(){for(var n=Array(256),s=Array(256),l=0;8>l;l+=1)n[l]=1<<l;for(l=8;256>l;l+=1)n[l]=n[l-4]^n[l-5]^n[l-6]^n[l-8];for(l=0;255>l;l+=1)s[n[l]]=l;return{g:function(t){if(1>t)throw Error("glog("+t+")");return s[t]},i:function(t){for(;0>t;)t+=255;for(;256<=t;)t-=255;return n[t]}}}(),g=function(){function n(t,i){switch(i){case f.L:return s[4*(t-1)];case f.M:return s[4*(t-1)+1];case f.Q:return s[4*(t-1)+2];case f.H:return s[4*(t-1)+3]}}var s=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12,7,37,13],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]],l={I:function(t,i){var u=n(t,i);if(typeof u>"u")throw Error("bad rs block @ typeNumber:"+t+"/errorCorrectLevel:"+i);t=u.length/3,i=[];for(var h=0;h<t;h+=1)for(var w=u[3*h],m=u[3*h+1],C=u[3*h+2],p=0;p<w;p+=1){var y=C,c={};c.o=m,c.j=y,i.push(c)}return i}};return l}();return r}());const Z=QrCreator;function D(z,...e){console.debug(z,...e)}class P{constructor(e){A(this,"data");A(this,"buffer");this.data=e,this.buffer=e.data}clone(){return new P(new ImageData(new Uint8ClampedArray(this.data.data),this.data.width,this.data.height))}get width(){return this.data.width}get height(){return this.data.height}rectangle(e,r,a,f,o){const d=this.data.width*4;for(let g=r*d;g<=(r+f)*d;g+=d)for(let n=e*4;n<(e+a)*4;n++)this.buffer[g+n]=o.c[n%4]}gradientRectangle(e,r,a,f,o,d){const g=[o.r,o.g,o.b,255],n=this.data.width*4;for(let s=r*n;s<=(r+f)*n;s+=n)for(let l=e*4;l<(e+a)*4;l++){const t=s+l,i=g[l%4]-this.buffer[t];this.buffer[t]+=Math.sign(i)*Math.abs(i)*d}}fadingGradientCircle(e,r,a,f){let o=r,d=0,g=1-o;for(;o>=d;){let n=f*(Math.abs(1+r-d)/r);this.fadingGradientHorizontalLine(e.x-o,2*o,e.y+d,a,n),d!==0&&this.fadingGradientHorizontalLine(e.x-o,2*o,e.y-d,a,n),d++,g>0?(o>=d&&(n=f*(Math.abs(r-o+1)/r),this.fadingGradientHorizontalLine(e.x-d+1,2*d-1,e.y-o,a,n),this.fadingGradientHorizontalLine(e.x-d+1,2*d-1,e.y+o,a,n)),o--,g+=2*(d-o+1)):g+=2*d+1}}fadingGradientHorizontalLine(e,r,a,f,o){const d=r/2,g=a*this.width*4;for(let n=0;n<r;n++){const s=(e+n)*4+g,l=o*(1-Math.abs((d-n)/d));for(let t=0;t<3;t++){const i=f.c[t%4]-this.buffer[s+t];this.buffer[s+t]+=Math.sign(i)*Math.abs(i)*l}}}gradientCircle(e,r,a,f){let o=r,d=0,g=1-o;for(;o>=d;)this.gradientHorizontalLine(e.x-o,2*o,e.y+d,a,f),d!==0&&this.gradientHorizontalLine(e.x-o,2*o,e.y-d,a,f),d++,g>0?(o>=d&&(this.gradientHorizontalLine(e.x-d+1,2*d-1,e.y-o,a,f),this.gradientHorizontalLine(e.x-d+1,2*d-1,e.y+o,a,f)),o--,g+=2*(d-o+1)):g+=2*d+1}gradientHorizontalLine(e,r,a,f,o){const d=a*this.width*4;for(let g=e*4+d;g<(e+r)*4+d;g++){const n=f.c[g%4]-this.buffer[g];this.buffer[g]+=Math.sign(n)*Math.abs(n)*o}}horizontalLine(e,r,a,f){for(let o=e;o<e+r;o++)this.set(o,a,f)}verticalLine(e,r,a,f){for(let o=e;o<e+r;o++)this.set(a,o,f)}line(e,r,a,f,o){e=Math.round(e),r=Math.round(r),a=Math.round(a),f=Math.round(f);const d=Math.abs(a-e),g=e<a?1:-1,n=-Math.abs(f-r),s=r<f?1:-1;let l=d+n;for(;;){if(e>1e5)throw Error("size of x0 grew unrealisticly big, coordinates given are most likely wrong");if(this.set(e,r,o),e===a&&r===f)break;const t=2*l;if(t>=n){if(e===a)break;l+=n,e+=g}else if(t<=d){if(r===f)break;l+=d,r+=s}}}set(e,r,a,f,o){if(typeof o<"u"&&typeof f<"u"&&typeof a=="number"){const n=this.data.width*4;let s=0,l=0;for(let t=r*n;t<=(r+f)*n;t+=n){for(let i=e*4;i<(e+a)*4;i++)this.buffer[t+i]=o[l][s],s++;l++}return}let d=e*4+r*this.width*4;const g=d+4;for(d;d<g;d++)this.buffer[d]=a.c[d%4]}get(e,r,a,f){if(typeof a<"u"&&typeof f<"u"){const g=this.width*4,n=[];for(let s=r*g;s<=(r+f)*g;s+=g)n.push(this.buffer.slice(s+e*4,s+(e+a)*4));return n}const o=this.data.width,d=r*o*4+e*4;return this.buffer.slice(d,d+4)}}class q{constructor(e,r,a){A(this,"cellStart");A(this,"cellEntries");A(this,"queryIds");A(this,"querySize");A(this,"spacing");A(this,"creaturesSize");A(this,"creatures");A(this,"width");A(this,"height");A(this,"rowLength");A(this,"columnLength");this.width=e,this.height=r,this.spacing=50,this.rowLength=Math.ceil(e/this.spacing),this.columnLength=Math.ceil(r/this.spacing);const f=this.rowLength*this.columnLength;this.cellStart=new Int32Array(f),this.cellEntries=new Int32Array,this.queryIds=new Int32Array,this.querySize=0,this.creaturesSize=0,this.creatures=a}update(){this.creatures.length>this.creaturesSize&&(this.cellEntries=new Int32Array(this.creatures.length),this.queryIds=new Int32Array(this.creatures.length)),this.creaturesSize=this.creatures.length,this.cellStart.fill(0),this.cellEntries.fill(0);for(const r of this.creatures){const a=this.getIndex(r.position);this.cellStart[a]+=1}let e=0;for(let r=0;r<this.cellStart.length;r++)e+=this.cellStart[r],this.cellStart[r]=e;for(let r=0;r<this.creatures.length;r++){const a=this.getIndex(this.creatures[r].position);this.cellStart[a]--,this.cellEntries[this.cellStart[a]]=r}}getIndex({x:e,y:r}){return e<0&&(e=this.width+e),e>this.width-1&&(e=e%this.width),r<0&&(r=this.height+r),r>this.height-1&&(r=r%this.height),Math.floor(e/this.spacing)+Math.floor(r/this.spacing)*this.rowLength}get(e,r){return e<0&&(e=this.rowLength+e),e>=this.rowLength&&(e=e%this.rowLength),r<0&&(r=this.columnLength+r),r>=this.columnLength&&(r=r%this.columnLength),e+r*this.rowLength}coordsFromIndex(e){return[e%this.rowLength*this.spacing,Math.floor(e/this.rowLength)*this.spacing]}nearestNeighbors(e,r){const a=this.creatures,f=this.creatures[e],o=r**2,d=((r+this.spacing)*2.83)**2,g=this.nearestNeighborsFromGrid(e,r),n=this.width,s=this.height;return{ids:g.ids,size:g.size,[Symbol.iterator](){let l=-1;const t=()=>{if(l++,l>=this.size)return{value:void 0,done:!0};const i=this.ids[l],u=a[i],h=u.position;let w=h.clone().sub(f.position);if(w.mag2()>d){const C=Q(n,s,f.position),p=Q(n,s,u.position);try{w=h.clone().add(b(n,s,C,p)).sub(f.position)}catch(y){throw console.error("Error in wrap correction",C,p,f.position,u.position,w,w.mag2(),r),y}}const m=w.mag2();return m>o?t():{value:[this.ids[l],w,m],done:!1}};return{next:t}}}}nearestNeighborsFromGrid(e,r){const{x:a,y:f}=this.creatures[e].position;this.querySize=0;const o=Math.floor((a-r)/this.spacing),d=Math.floor((f-r)/this.spacing),g=Math.floor((a+r)/this.spacing),n=Math.floor((f+r)/this.spacing);I.DEBUG_VISUAL&&window.simulation.painting.gradientCircle(this.creatures[e].position,r,new _(0,255,0),.1);for(let s=d;s<=n;s++)for(let l=o;l<=g;l++){const t=this.get(l,s);if(I.DEBUG_VISUAL){const[i,u]=this.coordsFromIndex(t);window.simulation.painting.gradientRectangle(i,u,this.spacing,this.spacing,new _(255,0,0),.1)}for(let i=this.cellStart[t];i<this.cellStart[t+1];i++){const u=this.cellEntries[i];u!==e&&(this.queryIds[this.querySize]=u,this.querySize++)}}return{ids:this.queryIds,size:this.querySize,[Symbol.iterator](){let s=-1;return{next:()=>(s++,s>=this.size?{value:0,done:!0}:{value:this.ids[s],done:!1})}}}}}function b(z,e,r,a){switch(r){case 0:switch(a){case 1:return T(-z,0);case 2:return T(0,-e);case 3:return T(-z,-e)}throw Error("neighbor can't be in the same quadrant if direction is above distance check");case 1:switch(a){case 0:return T(z,0);case 2:return T(z,-e);case 3:return T(0,-e)}throw Error("neighbor can't be in the same quadrant if direction is above distance check");case 2:switch(a){case 0:return T(0,e);case 1:return T(-z,e);case 3:return T(-z,0)}throw Error("neighbor can't be in the same quadrant if direction is above distance check");case 3:switch(a){case 0:return T(z,e);case 1:return T(0,e);case 2:return T(z,0)}throw Error("neighbor can't be in the same quadrant if direction is above distance check")}throw Error("neighbor can't be in the same quadrant if direction is above distance check")}function Q(z,e,r){const{x:a,y:f}=r;let o=0;return a>z/2&&(o+=1),f>e/2&&(o+=2),o}class k{constructor(){A(this,"html");A(this,"values");this.html=document.getElementById("debug"),this.values={}}set(e,r){this.values[e]=r,this.render()}render(){I.DEBUG_INFO&&(this.html.innerHTML=Object.entries(this.values).map(([e,r])=>`${e}: ${r}`).join("<br />"))}}const B=new k;function J(z){const e=Date.now();z();const r=Date.now()-e;I.DEBUG_INFO&&(B.set("fps",`${Math.round(1e3/r)}`),B.set("delay",`${r}ms`))}class tt{constructor(){A(this,"canvas");A(this,"ctx");A(this,"painting");A(this,"creatures");A(this,"viewdistance");this.canvas=document.getElementById("root"),this.ctx=this.canvas.getContext("2d"),this.ctx.canvas.width=window.innerWidth,this.ctx.canvas.height=window.innerHeight,D(`Created ${this.ctx.canvas.width}x${this.ctx.canvas.height} canvas`),this.creatures=[];for(let e=0;e<I.COUNT_START_CREATURES;e++)this.creatures.push(F.random());this.painting=new P(this.ctx.createImageData(this.canvas.width,this.canvas.height)),this.viewdistance=Math.min(this.canvas.height,this.canvas.width)/2-150,B.set("viewdistance",this.viewdistance),D("Created simulation with viewdistance",this.viewdistance)}get width(){return this.canvas.width}get height(){return this.canvas.height}start(){this.setup(),this.draw()}setup(){this.canvas.addEventListener("click",e=>{const r=e.pageX,a=e.pageY;this.addCreature(F.random({position:T(r,a)}))},!1)}draw(){const e=new q(this.canvas.width,this.canvas.height,this.creatures);if(this.painting.rectangle(0,0,this.painting.width,this.painting.height,new _(255,255,255)),I.CONSTANT_TIME_S>0){setInterval(()=>{this.drawLoop(e)},I.CONSTANT_TIME_S*1e3);return}requestAnimationFrame(()=>{I.DEBUG_INFO?J(()=>{this.drawLoop(e)}):this.drawLoop(e)})}drawLoop(e){I.DEBUG_INFO&&B.set("pixels",this.creatures.length),e.update(),this.updateCreatures(e);for(let a=0;a<this.creatures.length;a++){const f=this.creatures[a],o=f.position;this.painting.fadingGradientCircle(o,f.coloringSpread,f.color,f.coloringPercentage)}const r=this.painting.clone();for(let a=0;a<this.creatures.length;a++){const f=this.creatures[a],o=f.position,d=f.color,g=Math.max(...f.walk.p);r.set(o.x,o.y,d.clone().scale(f.walk.p[0]/g)),r.set(o.x+1,o.y,d.clone().scale(f.walk.p[1]/g)),r.set(o.x+1,o.y-1,d.clone().scale(f.walk.p[2]/g)),r.set(o.x,o.y-1,d.clone().scale(f.walk.p[3]/g)),r.set(o.x-1,o.y-1,d.clone().scale(f.walk.p[4]/g)),r.set(o.x-1,o.y,d.clone().scale(f.walk.p[5]/g)),r.set(o.x-1,o.y+1,d.clone().scale(f.walk.p[6]/g)),r.set(o.x,o.y+1,d.clone().scale(f.walk.p[7]/g)),r.set(o.x+1,o.y+1,d.clone().scale(f.walk.p[8]/g))}if(I.DEBUG_VISUAL){for(let a=e.spacing;a<r.width;a+=e.spacing)r.verticalLine(0,r.height,a,new _(0,0,0));for(let a=e.spacing;a<r.height;a+=e.spacing)r.horizontalLine(0,r.width,a,new _(0,0,0))}this.ctx.putImageData(r.data,0,0),I.CONSTANT_TIME_S===0&&requestAnimationFrame(()=>{I.DEBUG_INFO?J(()=>{this.drawLoop(e)}):this.drawLoop(e)})}updateCreatures(e){for(let r=0;r<this.creatures.length;r++){const a=this.creatures[r];a.update();for(const[f,o,d]of e.nearestNeighbors(r,this.viewdistance)){if(d<9&&(a.procreate(this.creatures[f]),console.log("Collision")),I.DEBUG_VISUAL){const{x:g,y:n}=a.position,{x:s,y:l}=a.position.clone().add(o.norm().scale(30).round());this.painting.line(g,n,s,l,new _(0,255,0))}a.updateWalk(o)}}for(let r=0;r<this.creatures.length;r++){const a=this.creatures[r];a.step();const{x:f,y:o}=a.position;f<0&&a.position.set(0,this.canvas.width+f),f>this.canvas.width-1&&a.position.set(0,f%this.canvas.width),o<0&&a.position.set(1,this.canvas.height+o),o>this.canvas.height-1&&a.position.set(1,o%this.canvas.height)}}addCreature(e){D("Adding creature "),console.log(JSON.stringify(e)),this.creatures.push(e)}}const{SYNC_SERVER_URL:et}=I,H=new tt;H.start();window.simulation=H;window.CONSTANTS=I;async function V(){let z=et;const e=new URLSearchParams(window.location.search).get("host");e!==null&&(z=`ws://${e}:7543`);const r=await X(z).catch(a=>{$(a)});if(typeof r>"u"){setTimeout(()=>{V().catch($)},500);return}r.on("close",async()=>{await V()}),typeof r<"u"&&(r.send({type:"init",connection_type:"canvas"}),r.send({type:"config",width:H.width,height:H.height}),r.on("message",a=>{const f=a;switch(f.type){case"id":{if(I.QR){const o=`${I.CONTROLLER_URL}?id=${f.id}`;document.getElementById("qr-link").setAttribute("href",o);const d=document.getElementById("qr");d.innerHTML="",Z.render({text:o,radius:.3,ecLevel:"H",fill:"#000",background:"#ffffff66",size:128},d)}break}case"create":{const o=new F(H.creatures.length,{position:T(...f.position),color:new _(f.color),personality:f.personality,ancestors:new Set});H.addCreature(o);break}}}))}V().catch($);
